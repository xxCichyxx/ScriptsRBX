-- Funkcja do uzyskania specyficznych części samochodu
local function getSpecificParts(car)
    local parts = {}
    local function addPartsFromFolder(folder)
        if folder and folder:IsA("Folder") then
            for _, child in pairs(folder:GetChildren()) do
                if child:IsA("BasePart") then
                    table.insert(parts, child)
                end
            end
        end
    end
    local hitbox = car:FindFirstChild("Hitbox")
    local wheels = car:FindFirstChild("Wheels")
    local main = car:FindFirstChild("Main")
    if hitbox then addPartsFromFolder(hitbox) end
    if wheels then addPartsFromFolder(wheels) end
    if main and main:IsA("BasePart") then table.insert(parts, main) end
    return parts
end

-- Funkcja obracania i skakania części
local function spinAndJumpCarPart(part, active)
    if active then
        local originalCFrame = part.CFrame
        part:SetAttribute("SpinJumpOriginalCFrame", originalCFrame)
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(0, 100000, 0)
        bodyVelocity.Velocity = Vector3.new(0, 5, 0) -- Płynny ruch w górę
        bodyVelocity.Parent = part

        task.spawn(function()
            while part:GetAttribute("SpinJumpActive") do
                bodyVelocity.Velocity = Vector3.new(0, math.sin(tick() * 5) * 5, 0) -- Ruch sinusoidalny
                task.wait(0.03)
            end
            -- Przywracanie oryginalnej pozycji
            bodyVelocity:Destroy()
            part.CFrame = originalCFrame
        end)
    else
        part:SetAttribute("SpinJumpActive", false)
    end
end

-- Funkcja autofarm
local function startAutofarm(parts, active)
    local maxHeight = 380
    local minHeight = 180
    local fallVelocity = -10
    local delayBetweenMoves = 0.05

    local function teleportPart(part)
        if not part:IsDescendantOf(workspace) then return end
        if active then
            part.CFrame = CFrame.new(part.Position.X, maxHeight, part.Position.Z)
            while part.Position.Y > minHeight and active do
                part.CFrame = CFrame.new(part.Position.X, part.Position.Y + fallVelocity, part.Position.Z)
                task.wait(delayBetweenMoves)
            end
            part.CFrame = CFrame.new(part.Position.X, maxHeight, part.Position.Z)
        else
            part.CFrame = part:GetAttribute("AutofarmOriginalCFrame") or part.CFrame
        end
    end

    for _, part in pairs(parts) do
        if active then
            part:SetAttribute("AutofarmOriginalCFrame", part.CFrame)
            coroutine.wrap(function()
                while active do
                    teleportPart(part)
                    task.wait(delayBetweenMoves)
                end
            end)()
        else
            teleportPart(part)
        end
    end
end

-- Zarządzanie monitorowaniem obracania/skakania
local spinJumpMonitoringActive = false
local spinJumpConnections = {}

local function startSpinJumpMonitoring()
    if spinJumpMonitoringActive then
        warn("SpinJump monitoring już działa!")
        return
    end

    local carsFolder = workspace:FindFirstChild("Cars")
    if not carsFolder then
        warn("Folder 'Cars' nie istnieje w workspace!")
        return
    end

    spinJumpMonitoringActive = true

    for _, car in pairs(carsFolder:GetChildren()) do
        if not car:GetAttribute("SpinJumpActivated") then
            car:SetAttribute("SpinJumpActivated", false)
        end

        local seats = car:FindFirstChild("Seats")
        local driverSeat = seats and seats:FindFirstChild("Driver")
        if driverSeat then
            -- Monitoruj zmiany Occupant, aby reagować na wsiadanie gracza
            local connection = driverSeat:GetPropertyChangedSignal("Occupant"):Connect(function()
                local occupant = driverSeat.Occupant
                if occupant then
                    local character = occupant.Parent
                    local player = game.Players:GetPlayerFromCharacter(character)
                    if player and player == game.Players.LocalPlayer and not car:GetAttribute("SpinJumpActivated") then
                        -- Rozpocznij SpinJump, jeśli monitorowanie jest aktywne
                        local parts = getSpecificParts(car)
                        for _, part in pairs(parts) do
                            -- Zapisz oryginalny CFrame, jeśli jeszcze nie zapisano
                            if not part:GetAttribute("SpinJumpOriginalCFrame") then
                                part:SetAttribute("SpinJumpOriginalCFrame", part.CFrame)
                            end
                            spinAndJumpCarPart(part, true)
                        end
                        car:SetAttribute("SpinJumpActivated", true)
                    end
                else
                    -- Jeżeli nie ma Occupanta, zatrzymaj SpinJump
                    if car:GetAttribute("SpinJumpActivated") then
                        local parts = getSpecificParts(car)
                        for _, part in pairs(parts) do
                            spinAndJumpCarPart(part, false)
                        end
                        car:SetAttribute("SpinJumpActivated", false)
                    end
                end
            end)

            table.insert(spinJumpConnections, connection)

            -- Jeśli gracz już siedzi w samochodzie, natychmiast aktywuj
            if driverSeat.Occupant then
                local occupant = driverSeat.Occupant
                local character = occupant.Parent
                local player = game.Players:GetPlayerFromCharacter(character)
                if player and player == game.Players.LocalPlayer and not car:GetAttribute("SpinJumpActivated") then
                    local parts = getSpecificParts(car)
                    for _, part in pairs(parts) do
                        if not part:GetAttribute("SpinJumpOriginalCFrame") then
                            part:SetAttribute("SpinJumpOriginalCFrame", part.CFrame)
                        end
                        spinAndJumpCarPart(part, true)
                    end
                    car:SetAttribute("SpinJumpActivated", true)
                end
            end
        end
    end

    print("Monitoring SpinJump aktywowany.")
end

local function stopSpinJumpMonitoring()
    spinJumpMonitoringActive = false

    local carsFolder = workspace:FindFirstChild("Cars")
    if carsFolder then
        for _, car in pairs(carsFolder:GetChildren()) do
            if car:GetAttribute("SpinJumpActivated") then
                local parts = getSpecificParts(car)
                for _, part in pairs(parts) do
                    -- Dezaktywuj flagę aktywności
                    part:SetAttribute("SpinJumpActive", false)

                    -- Usuń wszystkie elementy BodyVelocity i BodyAngularVelocity
                    for _, child in pairs(part:GetChildren()) do
                        if child:IsA("BodyMover") or child:IsA("BodyVelocity") or child:IsA("BodyAngularVelocity") then
                            child:Destroy()
                        end
                    end

                    -- Przywróć oryginalny CFrame
                    local originalCFrame = part:GetAttribute("SpinJumpOriginalCFrame")
                    if originalCFrame then
                        part.CFrame = originalCFrame
                    end
                end

                -- Zresetuj atrybut aktywacji
                car:SetAttribute("SpinJumpActivated", false)
            end
        end
    end
end

-- Zarządzanie monitorowaniem autofarm
local autofarmMonitoringActive = false
local autofarmConnections = {}

local function startAutofarmMonitoring()
    if autofarmMonitoringActive then
        warn("Autofarm monitoring jest już aktywny!")
        return
    end

    autofarmMonitoringActive = true

    local carsFolder = workspace:FindFirstChild("Cars")
    if not carsFolder then
        warn("Folder 'Cars' nie istnieje w workspace!")
        return
    end

    for _, car in pairs(carsFolder:GetChildren()) do
        if not car:GetAttribute("AutofarmActivated") then
            car:SetAttribute("AutofarmActivated", false)
        end

        local driverSeat = car:FindFirstChild("Seats") and car.Seats:FindFirstChild("Driver")

        if driverSeat then
            -- Monitoruj zmiany Occupant
            local connection = driverSeat:GetPropertyChangedSignal("Occupant"):Connect(function()
                local occupant = driverSeat.Occupant
                if occupant then
                    local character = occupant.Parent
                    local player = game.Players:GetPlayerFromCharacter(character)
                    if player and player == game.Players.LocalPlayer and not car:GetAttribute("AutofarmActivated") then
                        local parts = getSpecificParts(car)
                        startAutofarm(parts, true)
                        car:SetAttribute("AutofarmActivated", true)
                    end
                end
            end)

            table.insert(autofarmConnections, connection)

            -- Natychmiastowa aktywacja dla zajętych samochodów
            if driverSeat.Occupant then
                local occupant = driverSeat.Occupant
                local character = occupant.Parent
                local player = game.Players:GetPlayerFromCharacter(character)
                if player and player == game.Players.LocalPlayer and not car:GetAttribute("AutofarmActivated") then
                    local parts = getSpecificParts(car)
                    startAutofarm(parts, true)
                    car:SetAttribute("AutofarmActivated", true)
                end
            end
        end
    end
end

local function stopAutofarmMonitoring()
    autofarmMonitoringActive = false

    -- Odłącz wszystkie połączenia monitorujące
    for _, connection in pairs(autofarmConnections) do
        connection:Disconnect()
    end
    autofarmConnections = {}

    local carsFolder = workspace:FindFirstChild("Cars")
    if carsFolder then
        for _, car in pairs(carsFolder:GetChildren()) do
            if car:GetAttribute("AutofarmActivated") then
                local parts = getSpecificParts(car)
                startAutofarm(parts, false)
                car:SetAttribute("AutofarmActivated", false)
            end
        end
    end
end

return {
    startSpinJumpMonitoring = startSpinJumpMonitoring,
    stopSpinJumpMonitoring = stopSpinJumpMonitoring,
    startAutofarmMonitoring = startAutofarmMonitoring,
    stopAutofarmMonitoring = stopAutofarmMonitoring
}

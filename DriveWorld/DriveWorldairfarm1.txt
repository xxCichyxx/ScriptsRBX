local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local isMonitoring = false
local isActive = false
local currentCar = nil
local moveCoroutine = nil

-- Parametry wysokości
local minHeight = 250  -- Minimalna wysokość
local maxHeight = 650  -- Maksymalna wysokość
local correctionSpeed = 12  -- Szybkość korekty wysokości

-- Funkcja do ustawiania pojazdu w odpowiedniej wysokości (w obrębie minHeight - maxHeight)
local function maintainHeight(car)
    local carPrimaryPart = car.PrimaryPart

    while isActive do
        local currentPosition = carPrimaryPart.Position

        -- Odczytanie aktualnej wysokości i korekta w obrębie (minHeight - maxHeight)
        local currentHeight = currentPosition.Y
        local targetHeight = math.clamp(currentHeight, minHeight, maxHeight)

        -- Jeśli wysokość pojazdu różni się od żądanej, dostosuj ją
        if currentHeight ~= targetHeight then
            local targetPosition = Vector3.new(currentPosition.X, targetHeight, currentPosition.Z)
            carPrimaryPart.CFrame = CFrame.new(targetPosition)  -- Teleportuj pojazd na nową wysokość
        end

        -- Korekta kamery, aby patrzyła na pojazd
        local camera = game.Workspace.CurrentCamera
        local cameraPosition = carPrimaryPart.Position + Vector3.new(0, 10, 15)  -- Kamera lekko za pojazdem
        camera.CFrame = CFrame.new(cameraPosition, carPrimaryPart.Position)

        -- Czekaj chwilę, zanim pojazd znowu będzie teleportowany
        wait(0.1)
    end
end

-- Funkcja do wykrywania pojazdu
local function detectVehicle()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")

    for _, car in pairs(workspace.Cars:GetChildren()) do
        local seat = car:FindFirstChild("Seats") and car.Seats:FindFirstChild("Driver")
        if seat then
            seat:GetPropertyChangedSignal("Occupant"):Connect(function()
                if seat.Occupant == humanoid then
                    print("Gracz wsiadł do pojazdu: " .. car.Name)
                    if not isActive then
                        isActive = true
                        currentCar = car
                        -- Tworzymy coroutine do utrzymywania wysokości
                        moveCoroutine = coroutine.wrap(function()
                            maintainHeight(car)
                        end)
                        moveCoroutine()
                    end
                elseif seat.Occupant == nil then
                    print("Gracz wysiadł z pojazdu: " .. car.Name)
                    -- Zatrzymanie tylko ruchu pojazdu, monitoring nadal trwa
                    isActive = false
                end
            end)
        end
    end
end

-- Funkcja do włączania monitoringu
local function startMonitoring()
    if isMonitoring then
        print("Monitoring już jest włączony")
        return  -- Jeśli monitoring jest już włączony, nie rób nic
    end

    isMonitoring = true
    print("Monitoring włączony")

    -- Ciągła pętla monitorująca pojazdy
    coroutine.wrap(function()
        while isMonitoring do
            detectVehicle()  -- Sprawdzaj pojazdy
            wait(1)  -- Czekaj 1 sekundę przed kolejnym sprawdzeniem
        end
    end)()
end

-- Funkcja do wyłączania monitoringu
local function stopMonitoring()
    if not isMonitoring then
        print("Monitoring już jest wyłączony")
        return  -- Jeśli monitoring jest już wyłączony, nie rób nic
    end

    print("Monitoring wyłączony")

    isMonitoring = false
    isActive = false
    currentCar = nil

    -- Zatrzymujemy coroutine
    if moveCoroutine then
        coroutine.yield(moveCoroutine)
        moveCoroutine = nil
    end
end

return {
    startMonitoring = startMonitoring,
    stopMonitoring = stopMonitoring,
}

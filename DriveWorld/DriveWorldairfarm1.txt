local TweenService = game:GetService("TweenService")

local isMonitoring = false
local isActive = false
local currentCar = nil
local moveCoroutine = nil

-- Parametry lotu
local minHeight = 250  -- Minimalna wysokość
local maxHeight = 650  -- Maksymalna wysokość
local correctionSpeed = 16  -- Szybkość korekty (prędkość zmiany wysokości)

-- Funkcja do utrzymywania pojazdu na losowej wysokości w obrębie zakresu (250 - 550)
local function maintainRandomHeight(car)
    local carPrimaryPart = car.PrimaryPart

    while isActive do
        local currentPosition = carPrimaryPart.Position

        -- Losowanie wysokości w zakresie (minHeight - maxHeight)
        local targetHeight = math.random(minHeight, maxHeight)

        -- Ustawienie nowej pozycji z losową wysokością, ale ta sama X i Z
        local targetPosition = Vector3.new(currentPosition.X, targetHeight, currentPosition.Z)
        carPrimaryPart.CFrame = CFrame.new(targetPosition)  -- Teleportacja na losową wysokość

        -- Naprawa kamery - ustawienie kamery w prawidłowej pozycji, by widzieć pojazd
        local camera = game.Workspace.CurrentCamera
        local cameraPosition = carPrimaryPart.Position + Vector3.new(0, 10, 15)  -- Lekko za i nad pojazdem
        camera.CFrame = CFrame.new(cameraPosition, carPrimaryPart.Position)

        -- Czekaj chwilę, zanim pojazd znów zostanie teleportowany
        wait(0.1)
    end
end

-- Funkcja do wykrywania pojazdu
local function detectVehicle()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")

    for _, car in pairs(workspace.Cars:GetChildren()) do
        local seat = car:FindFirstChild("Seats") and car.Seats:FindFirstChild("Driver")
        if seat then
            seat:GetPropertyChangedSignal("Occupant"):Connect(function()
                if not isMonitoring then return end
                if seat.Occupant == humanoid then
                    print("Gracz wsiadł do pojazdu: " .. car.Name)
                    if not isActive then
                        isActive = true
                        currentCar = car
                        -- Tworzymy coroutine do utrzymywania wysokości
                        moveCoroutine = coroutine.wrap(function()
                            maintainRandomHeight(car)
                        end)
                        moveCoroutine()
                    end
                elseif seat.Occupant == nil then
                    print("Gracz wysiadł z pojazdu: " .. car.Name)
                    -- Zatrzymanie tylko ruchu pojazdu, monitoring nadal trwa
                    isActive = false
                end
            end)
        end
    end
end

-- Funkcja do włączania monitoringu
local function startMonitoring()
    if isMonitoring then
        print("Monitoring już jest włączony")
        return  -- Jeśli monitoring jest już włączony, nie rób nic
    end

    isMonitoring = true
    print("Monitoring włączony")

    -- Ciągła pętla monitorująca pojazdy
    coroutine.wrap(function()
        while isMonitoring do
            detectVehicle()  -- Sprawdzaj pojazdy
            wait(1)  -- Czekaj 1 sekundę przed kolejnym sprawdzeniem
        end
    end)()
end

-- Funkcja do wyłączania monitoringu
local function stopMonitoring()
    if not isMonitoring then
        print("Monitoring już jest wyłączony")
        return  -- Jeśli monitoring jest już wyłączony, nie rób nic
    end

    print("Monitoring wyłączony")

    isMonitoring = false
    isActive = false
    currentCar = nil

    -- Zatrzymujemy coroutine
    if moveCoroutine then
        coroutine.yield(moveCoroutine)
        moveCoroutine = nil
    end
end

return {
    startMonitoring = startMonitoring,
    stopMonitoring = stopMonitoring,
}
